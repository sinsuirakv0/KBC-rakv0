<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KBC World Time (改良版)</title>
  <style>
    :root {
      --bg:#0b1220; --card:#071427; --muted:#9fb0c8; --accent:#3b82f6;
      --glass: rgba(255,255,255,0.03); --text:#e6f0fb;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Noto Sans JP",sans-serif;
      background:linear-gradient(180deg,#051026 0%,#081428 60%);
      color:var(--text);
      padding:20px;
      display:flex;
      justify-content:center;
      animation: fadeIn 1s ease forwards;
      opacity:0;
    }

    @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

    .container{
      width:1100px; max-width:100%; display:grid; gap:16px;
    }
    .header{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
      padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1);
      animation: fadeIn 1s ease 0.2s forwards; opacity:0;
    }
    .logo{ display:flex; align-items:center; gap:10px; }
    .logo img{ width:40px; height:40px; border-radius:8px; box-shadow:0 0 10px rgba(59,130,246,0.4); animation: floatLogo 3s ease-in-out infinite; }
    @keyframes floatLogo { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    h1{margin:0;font-size:22px;}
    .nav{display:flex;gap:20px;flex-wrap:wrap;}
    .nav a{color:var(--muted);text-decoration:none;font-size:14px;transition:0.2s;}
    .nav a:hover{color:var(--accent);}

    /* hero + small explanation (keeps UI same) */
    .hero{
      text-align:center; padding:18px 20px; background:var(--card); border-radius:12px;
      box-shadow:0 8px 30px rgba(2,6,23,0.6); animation: fadeIn 1s ease 0.4s forwards; opacity:0;
      display:flex; flex-direction:column; gap:8px;
    }
    .hero h2{ font-size:22px; margin:0; color:var(--accent); }
    .hero p{ color:var(--muted); font-size:13px; margin:0; }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
      gap:16px;
      margin-top:6px;
    }
    .card{
      background:var(--card); border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(2,6,23,0.6);
      transition:transform 0.3s, box-shadow 0.3s; opacity:0; animation: fadeIn 1s ease forwards;
      min-height:120px; display:flex; flex-direction:column; gap:8px;
    }
    .card h3{ margin:0; font-size:16px; color:var(--accent); display:flex; justify-content:space-between; align-items:center; }
    .big-time{ font-size:20px; margin-top:6px; color:var(--text); font-weight:700; }
    .small{ color:var(--muted); font-size:13px; }

    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px; }
    .controls input[type="datetime-local"]{ background:var(--glass); border:1px solid rgba(255,255,255,0.05); color:var(--text); padding:8px 10px; border-radius:8px; font-size:13px; }
    .controls button{ background:linear-gradient(90deg,var(--accent),#60a5fa); border:none; color:white; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }

    .tz-list {
      margin-top:8px; max-height:360px; overflow:auto; border-radius:8px; border:1px solid rgba(255,255,255,0.03);
      padding:6px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));
    }
    .tz-row{ display:flex; justify-content:space-between; gap:8px; padding:8px; border-radius:6px; transition:background 0.12s; align-items:center; }
    .tz-row:hover{ background: rgba(255,255,255,0.02); cursor:pointer; }
    .tz-name{ font-size:14px; color:var(--text); }
    .tz-time{ font-size:13px; color:var(--muted); min-width:170px; text-align:right; }

    .card-tools { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .small-muted{ color:var(--muted); font-size:12px; }

    footer{ text-align:center; color:var(--muted); font-size:13px; margin-top:30px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px; animation: fadeIn 1s ease 1.2s forwards; opacity:0; }

    @media (max-width:640px){ .controls{ flex-direction:column; align-items:center; } .tz-time{ min-width:120px; } }
  </style>
</head>
<body>
  <div class="container">
    <!-- header (unchanged) -->
    <header class="header">
      <div class="logo">
        <img src="logo.png" alt="ロゴ">
        <h1>KBC</h1>
      </div>
      <nav class="nav">
        <a href="#">  </a><a href="#"></a><a href="#"></a><a href="#"></a>
      </nav>
    </header>

    <!-- hero (added light explanation under title as requested) -->
    <section class="hero" aria-live="polite">
      <h2>KBC World Time（改良版）</h2>
      <p>基準時刻は日本標準時 (Asia/Tokyo) をサーバー基準で扱います。手動で基準時刻を設定しても秒が進みます。タイムゾーンの割当てはカード単位で変更可能です。</p>
    </section>

    <!-- main grid: fixed 4 cards + dynamic changeable-cards container + tz list card -->
    <section class="grid" id="timeGrid">
      <!-- 固定カード群（常時表示） -->
      <div class="card" id="card-jst">
        <h3>現在時刻（日本時間） <span class="small-muted">Asia/Tokyo</span></h3>
        <div class="big-time" id="jst-time">--:--:--</div>
        <div class="small" id="jst-date">----</div>
      </div>

      <div class="card" id="card-samoa">
        <h3>米領サモア <span class="small-muted">Pacific/Pago_Pago (UTC−11)</span></h3>
        <div class="big-time" id="samoa-time">--:--:--</div>
        <div class="small" id="samoa-date">----</div>
      </div>

      <div class="card" id="card-kiri">
        <h3>キリバス <span class="small-muted">Pacific/Kiritimati (UTC＋14)</span></h3>
        <div class="big-time" id="kiri-time">--:--:--</div>
        <div class="small" id="kiri-date">----</div>
      </div>

      <div class="card" id="card-kiri-plus">
        <h3>キリバス +41時間（41時間後） <span class="small-muted">Pacific/Kiritimati</span></h3>
        <div class="big-time" id="kiri-plus-time">--:--:--</div>
        <div class="small" id="kiri-plus-date">----</div>
      </div>

      <!-- 変更可能カード群（ユーザーが増やせる） -->
      <div class="card" id="card-changeables">
        <h3>変更可能なカード <span class="small-muted">（カードを選んで、一覧からタイムゾーンを割当）</span></h3>

        <div id="changeablesContainer" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
          <!-- 動的にカードを追加 -->
        </div>

        <div class="card-tools">
          <button id="addCard">カードを追加</button>
          <button id="resetToNow">現在時刻に戻す</button>
          <div style="flex:1"></div>
          <div class="small-muted">ターゲットカード：<span id="activeCardLabel">なし</span></div>
        </div>

        <div class="controls" style="margin-top:8px;">
          <label style="font-size:13px;color:var(--muted);">基準時刻を手動で設定（JST）:
            <input id="manualDatetime" type="datetime-local" style="margin-left:6px;">
          </label>
          <button id="applyManual">適用</button>
        </div>
      </div>

      <!-- タイムゾーン一覧カード -->
      <div class="card" id="card-list">
        <h3>タイムゾーン一覧（全件） <span class="small-muted">検索・クリックで割当</span></h3>

        <div class="controls" style="margin-top:6px;">
          <input id="tzSearch" placeholder="検索（例: Tokyo, America, Europe）" style="flex:1;padding:8px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:var(--text)"/>
          <button id="reloadTz">再読み込み</button>
        </div>

        <div class="tz-list" id="tzList" style="margin-top:8px;">
          <div style="color:var(--muted);font-size:13px;padding:6px 4px;">読み込み中…</div>
        </div>

      </div>
    </section>

    <footer>© KBC World Time Viewer</footer>
  </div>

  <script>
  (function(){
    const API_BASE = 'https://worldtimeapi.org/api';
    const JST_TZ = 'Asia/Tokyo';
    const SAMOA_TZ = 'Pacific/Pago_Pago';
    const KIRITIMATI_TZ = 'Pacific/Kiritimati';

    // --- state for virtual time (works for manual setting + ticking) ---
    // serverBaseDate = Date object representing base moment (UTC time)
    // baseTimestamp = Date.now() when serverBaseDate was recorded
    let serverBaseDate = null;
    let baseTimestamp = Date.now();

    // elements
    const jstTimeEl = document.getElementById('jst-time');
    const jstDateEl = document.getElementById('jst-date');
    const samoaTimeEl = document.getElementById('samoa-time');
    const samoaDateEl = document.getElementById('samoa-date');
    const kiriTimeEl = document.getElementById('kiri-time');
    const kiriDateEl = document.getElementById('kiri-date');
    const kiriPlusTimeEl = document.getElementById('kiri-plus-time');
    const kiriPlusDateEl = document.getElementById('kiri-plus-date');

    const addCardBtn = document.getElementById('addCard');
    const changeablesContainer = document.getElementById('changeablesContainer');
    const activeCardLabel = document.getElementById('activeCardLabel');
    const manualDatetime = document.getElementById('manualDatetime');
    const applyManualBtn = document.getElementById('applyManual');
    const resetToNowBtn = document.getElementById('resetToNow');

    const tzListEl = document.getElementById('tzList');
    const tzSearch = document.getElementById('tzSearch');
    const reloadTzBtn = document.getElementById('reloadTz');

    // changeable cards state
    // each card: { id, tz, label, el } ; default tz = JST
    let changeableCards = [];
    let activeCardId = null;

    // tz list cache
    let tzCache = null;

    // --- helper: format by timezone into {date, time} strings ---
    function formatByTZ(dateObj, timeZone) {
      try {
        const def = { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false, timeZone };
        const fmt = new Intl.DateTimeFormat('ja-JP', def);
        const parts = fmt.formatToParts(dateObj);
        const p = {};
        parts.forEach(x => p[x.type] = x.value);
        const date = `${p.year}/${p.month}/${p.day}`;
        const time = `${p.hour}:${p.minute}:${p.second}`;
        return { date, time };
      } catch (e) {
        return { date: 'N/A', time: 'N/A' };
      }
    }

    // --- virtual now (serverBaseDate + elapsed) ---
    function getVirtualNow() {
      if (!serverBaseDate) return new Date();
      const elapsed = Date.now() - baseTimestamp;
      return new Date(serverBaseDate.getTime() + elapsed);
    }

    // --- sync server time (Asia/Tokyo) from API; fallback to device ---
    async function syncServerTime() {
      try {
        const res = await fetch(\`\${API_BASE}/timezone/\${JST_TZ}\`);
        if (!res.ok) throw new Error('api error');
        const data = await res.json();
        serverBaseDate = new Date(data.datetime); // includes offset
        baseTimestamp = Date.now();
        // fill manual input with JST-local truncated-minute
        manualDatetime.value = toDatetimeLocalValue(serverBaseDate);
        return true;
      } catch (e) {
        console.warn('sync failed, using device time', e);
        serverBaseDate = new Date();
        baseTimestamp = Date.now();
        manualDatetime.value = toDatetimeLocalValue(serverBaseDate);
        return false;
      }
    }

    // convert Date -> value for datetime-local (yyyy-MM-ddTHH:mm)
    function toDatetimeLocalValue(date) {
      // ensure JST
      const fmt = new Intl.DateTimeFormat('sv', { timeZone: JST_TZ, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      return fmt.format(date).replace(' ', 'T');
    }

    // --- render core fixed cards ---
    function renderFixedCards() {
      const now = getVirtualNow();
      const jst = formatByTZ(now, JST_TZ);
      jstTimeEl.textContent = jst.time; jstDateEl.textContent = jst.date + ' (Asia/Tokyo)';
      const sam = formatByTZ(now, SAMOA_TZ);
      samoaTimeEl.textContent = sam.time; samoaDateEl.textContent = sam.date + ' (' + SAMOA_TZ + ')';
      const k = formatByTZ(now, KIRITIMATI_TZ);
      kiriTimeEl.textContent = k.time; kiriDateEl.textContent = k.date + ' (' + KIRITIMATI_TZ + ')';
      const plus41 = new Date(now.getTime() + 41 * 3600 * 1000);
      const kp = formatByTZ(plus41, KIRITIMATI_TZ);
      kiriPlusTimeEl.textContent = kp.time; kiriPlusDateEl.textContent = kp.date + ' (' + KIRITIMATI_TZ + ' +41h)';
    }

    // --- changeable cards render/update ---
    function createChangeableCard() {
      const id = 'ch-' + (Date.now().toString(36).slice(6));
      const el = document.createElement('div');
      el.className = 'card';
      el.dataset.cardId = id;
      // structure
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="display:flex;flex-direction:column;">
            <div style="font-size:14px;color:var(--accent);">変更可能カード</div>
            <div class="small-muted" style="font-size:12px;">タイムゾーン: <span class="tz-label">Asia/Tokyo</span></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
            <label style="font-size:12px;color:var(--muted);"><input type="radio" name="activeCardRadio" style="margin-right:6px;"> 選択</label>
            <button class="removeCard" title="削除" style="background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:4px 8px;border-radius:6px;">削除</button>
          </div>
        </div>
        <div style="margin-top:6px;">
          <div class="big-time">--:--:--</div>
          <div class="small tz-date">----</div>
        </div>
      `;
      changeablesContainer.appendChild(el);

      const cardObj = {
        id, tz: JST_TZ, label: 'Asia/Tokyo', el
      };
      changeableCards.push(cardObj);

      // events
      const radio = el.querySelector('input[type="radio"]');
      radio.addEventListener('change', () => {
        setActiveCard(id);
      });

      const removeBtn = el.querySelector('.removeCard');
      removeBtn.addEventListener('click', () => {
        removeChangeableCard(id);
      });

      // if first card, select by default
      if (changeableCards.length === 1) {
        radio.checked = true;
        setActiveCard(id);
      }

      updateChangeableCardDisplay(cardObj);
    }

    function removeChangeableCard(id) {
      const idx = changeableCards.findIndex(c => c.id === id);
      if (idx >= 0) {
        const card = changeableCards[idx];
        card.el.remove();
        changeableCards.splice(idx,1);
        if (activeCardId === id) {
          activeCardId = changeableCards.length ? changeableCards[0].id : null;
          // set radio of new active (if exists)
          if (activeCardId) {
            const newCard = changeableCards[0].el.querySelector('input[type="radio"]');
            if (newCard) newCard.checked = true;
            activeCardLabel.textContent = changeableCards[0].label || 'なし';
          } else {
            activeCardLabel.textContent = 'なし';
          }
        }
      }
    }

    function setActiveCard(id) {
      activeCardId = id;
      const c = changeableCards.find(x => x.id === id);
      activeCardLabel.textContent = c ? c.label : 'なし';
    }

    function updateChangeableCardDisplay(cardObj) {
      const now = getVirtualNow();
      const fmt = formatByTZ(now, cardObj.tz);
      const timeEl = cardObj.el.querySelector('.big-time');
      const dateEl = cardObj.el.querySelector('.tz-date');
      const labelEl = cardObj.el.querySelector('.tz-label');
      if (timeEl) timeEl.textContent = fmt.time;
      if (dateEl) dateEl.textContent = fmt.date + ' (' + cardObj.tz + ')';
      if (labelEl) labelEl.textContent = toJapaneseTzLabel(cardObj.tz);
    }

    // update all changeable cards
    function updateAllChangeables() {
      changeableCards.forEach(c => updateChangeableCardDisplay(c));
    }

    // --- timezone list handling ---
    async function loadTimezoneList() {
      tzListEl.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:6px 4px;">読み込み中…</div>';
      try {
        const res = await fetch(\`\${API_BASE}/timezones\`);
        if (!res.ok) throw new Error('tz fetch failed');
        const list = await res.json(); // array of strings
        tzCache = list;
        renderTimezoneList(list);
      } catch (e) {
        console.warn('tz load failed', e);
        tzListEl.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:6px 4px;">タイムゾーン一覧の読み込みに失敗しました。</div>';
      }
    }

    function renderTimezoneList(list) {
      tzListEl.innerHTML = '';
      const fragment = document.createDocumentFragment();
      // show all zones
      list.forEach(tz => {
        const row = document.createElement('div');
        row.className = 'tz-row';
        row.dataset.tz = tz;
        const name = document.createElement('div');
        name.className = 'tz-name';
        name.textContent = toJapaneseTzLabel(tz); // Japanese-friendly label
        const time = document.createElement('div');
        time.className = 'tz-time';
        time.textContent = '—';
        row.appendChild(name);
        row.appendChild(time);

        // click: assign to active card (or copy if no active)
        row.addEventListener('click', async () => {
          if (activeCardId) {
            const card = changeableCards.find(c => c.id === activeCardId);
            if (card) {
              card.tz = tz;
              card.label = tz;
              updateChangeableCardDisplay(card);
              // brief highlight
              row.style.background = 'rgba(59,130,246,0.08)';
              setTimeout(()=> row.style.background = '', 500);
            }
          } else {
            // copy tz to clipboard as fallback
            try { await navigator.clipboard.writeText(tz); flashRow(row,'コピー済み'); }
            catch { flashRow(row,'選択カードがありません'); }
          }
        });

        fragment.appendChild(row);
      });
      tzListEl.appendChild(fragment);
      // update times immediately
      updateTzListTimes();
    }

    function flashRow(row, text) {
      const prev = row.querySelector('.tz-time');
      if (prev) {
        const old = prev.textContent;
        prev.textContent = text;
        setTimeout(()=> prev.textContent = old, 900);
      }
    }

    // update displayed times for tz-list
    function updateTzListTimes() {
      if (!tzCache) return;
      const now = getVirtualNow();
      const rows = tzListEl.querySelectorAll('.tz-row');
      rows.forEach(row => {
        const tz = row.dataset.tz;
        try {
          const f = formatByTZ(now, tz);
          row.querySelector('.tz-time').textContent = f.date + ' ' + f.time;
        } catch (e) {
          row.querySelector('.tz-time').textContent = 'N/A';
        }
      });
    }

    // filter search
    tzSearch.addEventListener('input', () => {
      const q = tzSearch.value.trim().toLowerCase();
      const rows = tzListEl.querySelectorAll('.tz-row');
      rows.forEach(r => {
        const label = r.querySelector('.tz-name').textContent.toLowerCase();
        const tz = r.dataset.tz.toLowerCase();
        if (!q || label.includes(q) || tz.includes(q)) r.style.display = '';
        else r.style.display = 'none';
      });
    });

    reloadTzBtn.addEventListener('click', () => loadTimezoneList());

    // --- Japanese-friendly label generator ---
    const regionMap = {
      'Asia':'アジア','Europe':'ヨーロッパ','America':'アメリカ','Pacific':'太平洋','Africa':'アフリカ','Australia':'オーストラリア','Indian':'インド洋','Antarctica':'南極'
    };
    const cityMap = {
      'Tokyo':'東京','Seoul':'ソウル','Taipei':'台北','Shanghai':'上海','Singapore':'シンガポール','New_York':'ニューヨーク','Los_Angeles':'ロサンゼルス','London':'ロンドン',
      'Paris':'パリ','Beijing':'北京','Mumbai':'ムンバイ','Kolkata':'コルカタ','Hong_Kong':'香港','Sydney':'シドニー','Honolulu':'ホノルル','Kiritimati':'キリバス','Pago_Pago':'サモア'
      // 必要に応じてここに追記可能
    };

    function toJapaneseTzLabel(tz) {
      // tz like "Region/City" or "Region/Subregion/City"
      const parts = tz.split('/');
      const region = parts[0] || '';
      const cityPart = parts.slice(1).join('/'); // keep subregions
      let cityKey = parts[parts.length - 1] || cityPart;
      // try mapping
      const cityKeyUnderscore = cityKey.replace(/ /g,'_');
      const mappedCity = cityMap[cityKeyUnderscore] || cityMap[cityKey] || cityKey.replace(/_/g,' ');
      const regionJp = regionMap[region] || region;
      return `${mappedCity} (${region}/${cityPart})`;
    }

    // --- manual set / apply / reset handlers ---
    applyManualBtn.addEventListener('click', () => {
      const v = manualDatetime.value;
      if (!v) return;
      // input value assumed JST (yyyy-mm-ddTHH:MM)
      // construct ISO with +09:00 so Date parses as correct JST instant
      const iso = v + ':00+09:00';
      serverBaseDate = new Date(iso);
      baseTimestamp = Date.now();
      // update immediately (and seconds will tick because we use virtual now)
      renderAll();
    });

    resetToNowBtn.addEventListener('click', async () => {
      // re-sync from API (preferred): if fails, set to device "now"
      const ok = await syncServerTime();
      if (!ok) {
        serverBaseDate = new Date();
        baseTimestamp = Date.now();
      }
      renderAll();
    });

    // add card button
    addCardBtn.addEventListener('click', () => {
      createChangeableCard();
    });

    // --- render loop ---
    function renderAll() {
      renderFixedCards();
      updateAllChangeables();
      updateTzListTimes();
    }

    // tick every second
    setInterval(renderAll, 1000);

    // initial boot
    (async function init(){
      await syncServerTime();
      // create two default changeable cards
      createChangeableCard();
      createChangeableCard();
      renderAll();
      // ensure tz-list loaded
      await loadTimezoneList();
      // set manual input default
      manualDatetime.value = toDatetimeLocalValue(serverBaseDate || new Date());
    })();

    // --- Utilities for debugging (optional) ---
    window._kbc = {
      getState: () => ({ serverBaseDate, baseTimestamp, changeableCards })
    };

  })();
  </script>
</body>
</html>